name: Auto Merge All PRs

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Merge all PRs in ascending order
        env:
          TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Fetching PR list..."

          PRS=$(curl -s \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/pulls?state=open&per_page=100" \
            | jq -r '.[].number' | sort -n)

          echo "Sorted PRs: $PRS"

          for PR in $PRS; do
            echo "Merging PR #$PR ..."

            curl -s -X PUT \
              -H "Authorization: token $TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/pulls/$PR/merge" \
              -d '{"merge_method":"squash"}'

            echo ""
          done
