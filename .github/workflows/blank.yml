MAX_RETRIES=3

for PR in $PRS; do
  echo "Processing PR #$PR ..."
  
  for attempt in $(seq 1 $MAX_RETRIES); do
    RESPONSE=$(curl -s -X PUT \
      -H "Authorization: token $TOKEN" \
      -H "Accept: application/vnd.github+json" \
      "https://api.github.com/repos/$REPO/pulls/$PR/merge" \
      -d '{"merge_method":"squash"}')

    MESSAGE=$(echo $RESPONSE | jq -r '.message // empty')
    
    if [ "$MESSAGE" == "" ]; then
      echo "PR #$PR merged successfully."
      break
    elif [[ "$MESSAGE" == *"Base branch was modified"* ]]; then
      echo "PR #$PR cannot merge because base branch changed. Retrying in 5 seconds... (Attempt $attempt/$MAX_RETRIES)"
      sleep 5
    else
      echo "PR #$PR merge failed: $MESSAGE"
      break
    fi
  done
done
