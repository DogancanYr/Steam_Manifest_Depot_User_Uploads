name: Auto Merge All PRs

on:
  schedule:
    - cron: '*/5 * * * *' # Her 5 dakikada bir çalışır
  workflow_dispatch: # Manuel tetikleme

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Merge all eligible PRs
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }} # PAT ile merge
          REPO: ${{ github.repository }}
        run: |
          echo "Fetching open PRs..."
          PRS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/pulls?state=open&per_page=100" | jq -r '.[].number')

          for PR in $PRS; do
            echo "Checking PR #$PR..."
            
            # Fork kontrolü
            IS_FORK=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/pulls/$PR" | jq -r '.head.repo.full_name != .base.repo.full_name')
            
            # Label kontrolü
            HAS_LABEL=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/pulls/$PR" | jq -r '.labels[]?.name | select(. == "auto-merge")')

            # Merge izni kontrolü
            if [[ "$IS_FORK" == "false" || -n "$HAS_LABEL" ]]; then
              echo "Merging PR #$PR..."
              curl -s -X PUT \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$REPO/pulls/$PR/merge" \
                -d '{"commit_title":"Auto-merged via API","merge_method":"squash"}'
            else
              echo "Skipping PR #$PR (fork without label)"
            fi
          done
