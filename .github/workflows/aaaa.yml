name: PR Depot Process Optimized API-Only

on:
  schedule:
    - cron: '*/5 * * * *'  # Her 5 dakikada bir Ã§alÄ±ÅŸacak
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  process:
    name: Process Steam Depot Files
    runs-on: windows-latest

    steps:
      # Projeyi ve git geÃ§miÅŸini Ã§ek (Commit adÄ±mÄ± iÃ§in gerekli)
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }} # PAT token'Ä± kullanÄ±yoruz
          fetch-depth: 0 # TÃ¼m geÃ§miÅŸi Ã§ek (isteÄŸe baÄŸlÄ± ama Ã¶nerilir)

      # --- 1) PR Listesini API ile Al (En KÃ¼Ã§Ã¼k PR) ---
      - name: Fetch Smallest Open PR via API
        id: fetch_pr
        shell: pwsh
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO_NAME: ${{ github.repository }}
        run: |
          Write-Host "ğŸ“‹ TÃ¼m aÃ§Ä±k PR'ler Ã§ekiliyor..."

          $headers = @{
              Authorization = "token $env:PAT_TOKEN"
              Accept        = "application/vnd.github.v3+json"
          }

          # Ä°lk 100 aÃ§Ä±k PR'i Ã§ek
          $url = "https://api.github.com/repos/$env:REPO_NAME/pulls?state=open&per_page=100"
          $prs = Invoke-RestMethod -Headers $headers -Uri $url -Method Get

          if (-not $prs) {
              Write-Host "âš ï¸ AÃ§Ä±k PR bulunamadÄ±. Ä°ÅŸlem atlanÄ±yor."
              echo "PR_NUMBER=0" >> $env:GITHUB_OUTPUT
              exit 0
          }

          # PR numaralarÄ±nÄ± al ve en kÃ¼Ã§Ã¼k olanÄ± bul
          $minPRNumber = ($prs | Select-Object -ExpandProperty number | Measure-Object -Minimum).Minimum

          # En kÃ¼Ã§Ã¼k PR'yi bul
          $minPR = $prs | Where-Object { $_.number -eq $minPRNumber }

          # Sonraki adÄ±mlar iÃ§in gerekli bilgiyi dosyaya kaydet
          "$($minPR.number) $($minPR.head.repo.full_name)" | Set-Content -Path "pr_info.txt"
          
          Write-Host "âœ… En kÃ¼Ã§Ã¼k PR numarasÄ± kaydedildi: $($minPR.number)"
          echo "PR_NUMBER=$minPRNumber" >> $env:GITHUB_OUTPUT

      # PR bulunamazsa sonraki adÄ±mlarÄ± atla
      - name: Skip if No PR Found
        if: steps.fetch_pr.outputs.PR_NUMBER == '0'
        run: |
          Write-Host "AÃ§Ä±k PR bulunmadÄ±ÄŸÄ± iÃ§in sonraki adÄ±mlar atlanÄ±yor."
          exit 0
          
      # --- 2) PR DosyalarÄ±nÄ± API ile Ä°ndir ---
      - name: Fetch PR Files
        shell: pwsh
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO_NAME: ${{ github.repository }}
        run: |
          $tempDir = "process_tmp"
          New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

          foreach ($line in Get-Content "pr_info.txt") {
              $parts = $line.Split(' ')
              $prNumber = $parts[0]
              # $headRepo = $parts[1] # Bu bilgiyi bu adÄ±mda kullanmÄ±yoruz

              Write-Host "ğŸ“¥ PR #$prNumber dosyalarÄ± Ã§ekiliyor..."

              $page = 1
              do {
                  $url = "https://api.github.com/repos/$env:REPO_NAME/pulls/$prNumber/files?per_page=100&page=$page"
                  $files = Invoke-RestMethod -Headers @{Authorization="token $env:PAT_TOKEN"; Accept="application/vnd.github.v3+json"} -Uri $url -Method Get
                  if ($files.Count -eq 0) { break }

                  foreach ($file in $files) {
                      if ($file.status -eq "removed") { continue }
                      $fullPath = Join-Path $tempDir $file.filename
                      $dir = Split-Path -Parent $fullPath
                      if (-not (Test-Path $dir)) { New-Item -ItemType Directory -Path $dir -Force | Out-Null }
                      
                      # RAW URL'den dosya iÃ§eriÄŸini indir
                      Invoke-WebRequest -Uri $file.raw_url -OutFile $fullPath -ErrorAction Stop
                      Write-Host "â¬‡ï¸ $($file.filename) indirildi"
                  }

                  $page++
              } while ($files.Count -eq 100)
          }
          
      # --- 3) Depot Tools Ä°ndir ---
      - name: Download Depot Dumper Tool
        shell: pwsh
        run: |
          $toolDir = New-Item -ItemType Directory -Path "DepotDumper" -Force
          $toolUrl = "https://raw.githubusercontent.com/DogancanYr/Steam_Manifest_Depot/main/DepotDumper/Depot.exe"
          
          Write-Host "ğŸ› ï¸ Depot.exe indiriliyor..."
          Invoke-WebRequest -Uri $toolUrl -OutFile (Join-Path $toolDir "Depot.exe") -ErrorAction Stop

          Write-Host "âœ… Depot.exe indirildi."

      # --- 4) Depot Ä°ÅŸlemi (Secrets Kullanarak) ---
      - name: Run Depot Dumper and Collect Files
        id: depot_run
        shell: pwsh
        env:
          DEPOT_USER: ${{ secrets.DEPOT_USERNAME }} 
          DEPOT_PASS: ${{ secrets.DEPOT_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'
          
          $inputDir = "process_tmp"
          $outputDir = New-Item -ItemType Directory -Path "collected" -Force
          $depotExe = Join-Path $PWD "DepotDumper\Depot.exe"

          if (-not (Test-Path $inputDir)) {
              Write-Host "â„¹ï¸ Ä°ÅŸlenecek dosya klasÃ¶rÃ¼ (process_tmp) yok, iÅŸlem atlanÄ±yor."
              exit 0
          }

          # *_pkgs.txt dosyalarÄ±nÄ± bul
          $pkgFiles = Get-ChildItem -Path $inputDir -Filter '*_pkgs.txt' -Recurse -File

          if ($pkgFiles.Count -eq 0) {
              Write-Warning "âš ï¸ Ä°ÅŸlenecek *_pkgs.txt dosyasÄ± bulunamadÄ±. Ä°ÅŸlem baÅŸarÄ±yla atlanÄ±yor."
              exit 0
          }

          Write-Host "âœ”ï¸ *_pkgs.txt dosyalarÄ± bulundu: $($pkgFiles.Count)"

          foreach ($pkg in $pkgFiles) {
          
              $pkgPath = $pkg.FullName
              $pkgDirectory = Split-Path -Parent $pkgPath
              $prefix = $pkg.BaseName -replace '_pkgs$', ''
              $keyFile = Join-Path $pkgDirectory "${prefix}_keys.txt"

              if (-not (Test-Path $keyFile)) {
                  Write-Warning "âš ï¸ $($pkg.Name) iÃ§in anahtar dosyasÄ± bulunamadÄ±. AtlanÄ±yor."
                  continue
              }

              Write-Host "ğŸš€ Ä°ÅŸleniyor: $($pkg.Name)"

              $content = Get-Content -Raw $pkgPath | ForEach-Object { $_ -replace '^\uFEFF', '' } 
              $firstLine = $content.Trim().Split("`n")[0]
              $parts = $firstLine -split ';'

              if ($parts.Count -lt 2) {
                  Write-Error "âŒ Format hatasÄ±: $($pkg.Name). (app;token formatÄ±nda olmalÄ±)"
                  continue
              }

              $appId = $parts[0].Trim()
              $token = $parts[1].Trim()
              Write-Host "    AppID: $appId"

              # --- TRY / CATCH / FINALLY ---
              Push-Location $outputDir
              try {
                  & $depotExe -username $env:DEPOT_USER -password $env:DEPOT_PASS -app $appId -packagetoken $token -depotkeys $keyFile
                  Write-Host "âœ… $($pkg.Name) iÅŸlemi tamamlandÄ±."
              }
              catch {
                  Write-Error "âŒ Depot Dumper hatasÄ±: $_"
              }
              finally {
                  Pop-Location
              }
          } # foreach kapanÄ±ÅŸÄ±

          # Hata ayÄ±klama iÃ§in son klasÃ¶r iÃ§eriÄŸini gÃ¶ster
          Write-Host "--- collected KlasÃ¶r Ä°Ã§eriÄŸi ---"
          Get-ChildItem -Path $outputDir -Recurse | Select-Object FullName
          Write-Host "--------------------------------"


      # --- 5) Commit ve Push ---
      - name: Commit and Push via PAT
        shell: pwsh
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          BRANCH: main  # Veya istediÄŸin branch
        run: |
          # Checkout yapÄ±ldÄ±ÄŸÄ± iÃ§in yeniden init/remote eklemeye gerek yok
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # YalnÄ±zca 'collected' iÃ§indeki deÄŸiÅŸiklikleri ekle
          git add collected/
          
          # DeÄŸiÅŸiklik var mÄ± kontrol et
          if (git diff --cached --quiet) { 
              Write-Host "â„¹ï¸ Yeni deÄŸiÅŸiklik yok. Commit atlanÄ±yor." 
          }
          else {
              $prNumber = (Get-Content "pr_info.txt").Split(' ')[0]
              git commit -m "Auto-process: Added depot files from PR #${prNumber}"
              Write-Host "ğŸš€ DeÄŸiÅŸiklikler $env:BRANCH branch'ine push ediliyor..."
              git push 
          }
