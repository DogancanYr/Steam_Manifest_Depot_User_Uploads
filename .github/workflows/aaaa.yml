name: Auto Merge All PRs

on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Merge all PRs in ascending order with retries
        env:
          TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO: ${{ github.repository }}
          MAX_RETRIES: 3
        run: |
          echo "Fetching PR list..."

          PRS=$(curl -s \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/pulls?state=open&per_page=100" \
            | jq -r '.[].number' | sort -n)

          echo "Sorted PRs: $PRS"

          for PR in $PRS; do
            echo "Processing PR #$PR ..."

            for attempt in $(seq 1 $MAX_RETRIES); do
              RESPONSE=$(curl -s -X PUT \
                -H "Authorization: token $TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$REPO/pulls/$PR/merge" \
                -d '{"merge_method":"squash"}')

              MESSAGE=$(echo $RESPONSE | jq -r '.message // empty')

              if [ "$MESSAGE" == "" ]; then
                echo "PR #$PR merged successfully."
                break
              elif [[ "$MESSAGE" == *"Base branch was modified"* ]]; then
                echo "PR #$PR cannot merge because base branch changed. Retrying in 5 seconds... (Attempt $attempt/$MAX_RETRIES)"
                sleep 5
              else
                echo "PR #$PR merge failed: $MESSAGE"
                break
              fi
            done
          done
