name: Scheduled Depot Process (Bypass Checkout)

# Ä°ÅŸ akÄ±ÅŸÄ±nÄ± haftalÄ±k veya manuel olarak tetikle
on:
  schedule:
    # HaftalÄ±k Pazar 03:00
    - cron: '*/1 * * * *'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Process edilecek PR numarasÄ±'
        required: true
        type: number

# Ä°ÅŸlem iÃ§in gerekli izinler
permissions:
  contents: write    # Repository'ye commit/push yapabilmek iÃ§in
  pull-requests: write # PR'Ä± kapatabilmek ve yorum ekleyebilmek iÃ§in

jobs:
  process:
    name: Process Steam Depot Files
    runs-on: windows-latest
    
    # Sadece workflow_dispatch ile tetiklendiÄŸinde Ã§alÄ±ÅŸÄ±r
    if: github.event_name == 'workflow_dispatch'

    steps:
      # --- 1) PR NumarasÄ±nÄ± Belirle ---
      - name: Set PR Number
        id: pr_num_step
        run: |
          echo "PR_NUMBER::${{ github.event.inputs.pr_number }}" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        shell: pwsh
        
      # --- 2) Repo'yu Manuel Olarak Klonla (actions/checkout yerine) ---
      - name: Manual Clone Repository
        id: manual_clone
        shell: bash
        env:
          TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Cloning repository..."
          # PAT_TOKEN kullanarak repository'yi klonla
          git clone https://x-access-token:$TOKEN@github.com/$REPO .
          git config user.name "DogancanYr"
          git config user.email "DogancanYr@users.noreply.github.com"
          git fetch origin --unshallow # TÃ¼m geÃ§miÅŸi getir (Depot iÅŸlemi iÃ§in gerekebilir)
          
      # --- 3) PR DosyalarÄ±nÄ± Ä°ndir (Ä°ÅŸlenecek Dosyalar) ---
      - name: Fetch PR Files
        id: fetch_files
        shell: pwsh
        env:
          TOKEN: ${{ secrets.PAT_TOKEN }} # PAT_TOKEN kullan
          REPO_NAME: ${{ github.repository }}
          PR_NUMBER: ${{ steps.pr_num_step.outputs.PR_NUMBER }}
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "ğŸ“¥ PR #$env:PR_NUMBER dosyalarÄ± taranÄ±yor ve indiriliyor..."

          $headers = @{
            Authorization = "token $env:TOKEN"
            Accept        = "application/vnd.github.v3+json"
          }

          $url = "https://api.github.com/repos/$env:REPO_NAME/pulls/$env:PR_NUMBER/files?per_page=100"
          $files = Invoke-RestMethod -Headers $headers -Uri $url -Method Get

          if (-not $files) {
            Write-Warning "âš ï¸ PR iÃ§inde dosya bulunamadÄ± veya API yanÄ±t vermedi. Ä°ÅŸlem atlanÄ±yor."
            echo "DOWNLOAD_COUNT::0" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          $tempDir = New-Item -ItemType Directory -Path "process_tmp" -Force
          $downloadCount = 0

          foreach ($file in $files) {
            if ($file.status -eq "removed") { continue }
            
            $fullPath = Join-Path $tempDir $file.filename
            $dir = Split-Path -Parent $fullPath
            if (-not (Test-Path $dir)) { New-Item -ItemType Directory -Path $dir -Force | Out-Null }

            try {
              # DosyayÄ± indir
              Invoke-WebRequest -Uri $file.raw_url -OutFile $fullPath -ErrorAction Stop
              $downloadCount++
            }
            catch {
              Write-Error "âŒ Ä°ndirme hatasÄ±: $($file.filename) - $_"
            }
          }

          echo "DOWNLOAD_COUNT::$downloadCount" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

          if ($downloadCount -eq 0) {
            Write-Warning "âš ï¸ Ä°ÅŸlenecek dosya bulunamadÄ± (removed dÄ±ÅŸÄ±ndaki dosyalar)."
            exit 0
          }

          Write-Host "âœ… Toplam $downloadCount dosya baÅŸarÄ±yla indirildi."
          
      # --- 4) Depot Tools Ä°ndir ---
      - name: Download Depot Dumper Tool
        if: steps.fetch_files.outputs.DOWNLOAD_COUNT > 0
        shell: pwsh
        run: |
          $toolDir = New-Item -ItemType Directory -Path "DepotDumper" -Force
          $toolUrl = "https://raw.githubusercontent.com/DogancanYr/Steam_Manifest_Depot/main/DepotDumper/Depot.exe"
          
          Write-Host "ğŸ› ï¸ Depot.exe indiriliyor..."
          Invoke-WebRequest -Uri $toolUrl -OutFile (Join-Path $toolDir "Depot.exe") -ErrorAction Stop
          Write-Host "âœ… Depot.exe indirildi."

      # --- 5) Depot Ä°ÅŸlemi (Secrets Kullanarak) ---
      - name: Run Depot Dumper and Collect Files
        id: depot_run
        if: steps.fetch_files.outputs.DOWNLOAD_COUNT > 0
        shell: pwsh
        env:
          # Secrets Ã§alÄ±ÅŸmÄ±yorsa bu deÄŸerleri kullan:
          DEPOT_USER: Bt5Pd3Zm9Sz4 
          DEPOT_PASS: Yk2Ho8Wl5Im2
        run: |
          $ErrorActionPreference = 'Stop'
          $inputDir = "process_tmp"
          $outputDir = New-Item -ItemType Directory -Path "collected" -Force
          $depotExe = Join-Path $PWD "DepotDumper\Depot.exe"
          $pkgFiles = Get-ChildItem -Path $inputDir -Filter '*_pkgs.txt' -Recurse -File

          if ($pkgFiles.Count -eq 0) {
              Write-Warning "âš ï¸ Ä°ÅŸlenecek *_pkgs.txt dosyasÄ± bulunamadÄ±. Ä°ÅŸlem baÅŸarÄ±yla atlanÄ±yor."
              echo "PROCESSED_COUNT::0" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              exit 0
          }

          $processedCount = 0
          foreach ($pkg in $pkgFiles) {
              $pkgPath = $pkg.FullName
              $pkgDirectory = Split-Path -Parent $pkgPath
              $prefix = $pkg.BaseName -replace '_pkgs$', ''
              $keyFile = Join-Path $pkgDirectory "${prefix}_keys.txt"

              if (-not (Test-Path $keyFile)) { Write-Warning "âš ï¸ $($pkg.Name) iÃ§in anahtar dosyasÄ± bulunamadÄ±. AtlanÄ±yor."; continue }

              $content = Get-Content -Raw $pkgPath | ForEach-Object { $_ -replace '^\uFEFF', '' }  
              $parts = $content.Trim().Split("`n")[0] -split ';'

              if ($parts.Count -lt 2) { Write-Error "âŒ Format hatasÄ±: $($pkg.Name)."; continue }

              $appId = $parts[0].Trim()
              $token = $parts[1].Trim()

              Push-Location $outputDir
              try {
                  & $depotExe -username $env:DEPOT_USER -password $env:DEPOT_PASS -app $appId -packagetoken $token -depotkeys $keyFile -Verbose
                  $processedCount++
              }
              catch { Write-Error "âŒ Depot Dumper hatasÄ±: $_" }
              finally { Pop-Location }
          } 
          
          echo "PROCESSED_COUNT::$processedCount" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          
      # --- 6) SonuÃ§larÄ± Commit ve Push Et ---
      - name: Commit and Push Results
        # Ä°ÅŸlenen dosya varsa push et
        if: steps.depot_run.outputs.PROCESSED_COUNT > 0
        shell: bash
        env:
          TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # Git config ayarlarÄ± 2. adÄ±mda yapÄ±ldÄ±.
          git add collected/
          
          if git diff --cached --quiet; then
            echo "â„¹ï¸ collected/ klasÃ¶rÃ¼nde yeni deÄŸiÅŸiklik yok, push yapÄ±lmayacak."
          else
            echo "ğŸ“¦ Yeni Depot dosyalarÄ± commitleniyor..."
            # Ana dala (main/master) commit et ve pushla
            git commit -m "Auto-process: Added depot files from PR #${{ steps.pr_num_step.outputs.PR_NUMBER }}"
            
            # PAT_TOKEN kullanarak push et
            git push https://x-access-token:$TOKEN@github.com/$REPO HEAD:main
          fi

      # --- 7) PR'Ä± Kapat ve Yorum Ekle ---
      - name: Close Pull Request
        # Ä°ÅŸlem baÅŸarÄ±lÄ± olduysa ve geÃ§erli bir PR numarasÄ± varsa kapat
        if: success() && steps.pr_num_step.outputs.PR_NUMBER > 0 
        uses: peter-evans/close-pull@v3
        with:
          pull-request-number: ${{ steps.pr_num_step.outputs.PR_NUMBER }}
          comment: |
            âœ… **Ä°ÅŸlem TamamlandÄ±!** Depot dosyalarÄ± iÅŸlendi ve repoya eklendi.
            
          delete-branch: true
