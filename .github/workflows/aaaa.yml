name: PR Depot Process Optimized API-Only

on:
  schedule:
    - cron: '*/5 * * * *'  # Her 5 dakikada bir √ßalƒ±≈üacak
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  process:
    name: Process Steam Depot Files
    runs-on: windows-latest

    steps:
      # --- 1) PR Listesini API ile Al (En K√º√ß√ºk PR) ---
      - name: Fetch Smallest Open PR via API
        shell: pwsh
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO_NAME: ${{ github.repository }}
        run: |
          Write-Host "üìã T√ºm a√ßƒ±k PR'ler √ßekiliyor..."

          $headers = @{
              Authorization = "token $env:PAT_TOKEN"
              Accept        = "application/vnd.github.v3+json"
          }

          # ƒ∞lk 100 a√ßƒ±k PR'i √ßek (daha fazlasƒ± i√ßin pagination gerekir)
          $url = "https://api.github.com/repos/$env:REPO_NAME/pulls?state=open&per_page=100"
          $prs = Invoke-RestMethod -Headers $headers -Uri $url -Method Get

          if (-not $prs) {
              Write-Host "‚ö†Ô∏è A√ßƒ±k PR bulunamadƒ±. ƒ∞≈ülem atlanƒ±yor."
              exit 0
          }

          # PR numaralarƒ±nƒ± al
          $prNumbers = $prs | ForEach-Object { $_.number }

          # En k√º√ß√ºk PR numarasƒ±nƒ± bul
          $minPRNumber = ($prNumbers | Measure-Object -Minimum).Minimum

          # En k√º√ß√ºk PR'nin repository bilgisini al
          $minPR = $prs | Where-Object { $_.number -eq $minPRNumber }

          "$($minPR.number) $($minPR.head.repo.full_name)" | Set-Content -Path "pr_list.txt"
          Write-Host "‚úÖ En k√º√ß√ºk PR numarasƒ± kaydedildi: $($minPR.number)"


      # --- 2) PR Dosyalarƒ±nƒ± API ile ƒ∞ndir ---
      - name: Fetch PR Files
        shell: pwsh
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO_NAME: ${{ github.repository }}
        run: |
          $tempDir = "process_tmp"
          New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

          foreach ($line in Get-Content "pr_list.txt") {
              $parts = $line.Split(' ')
              $prNumber = $parts[0]
              $headRepo = $parts[1]

              Write-Host "üì• PR #$prNumber ($headRepo) dosyalarƒ± √ßekiliyor..."

              # Fork ise atla merge ama dosya √ßekmeye izin var
              $page = 1
              do {
                  $url = "https://api.github.com/repos/$env:REPO_NAME/pulls/$prNumber/files?per_page=100&page=$page"
                  $files = Invoke-RestMethod -Headers @{Authorization="token $env:PAT_TOKEN"; Accept="application/vnd.github.v3+json"} -Uri $url -Method Get
                  if ($files.Count -eq 0) { break }

                  foreach ($file in $files) {
                      if ($file.status -eq "removed") { continue }
                      $fullPath = Join-Path $tempDir $file.filename
                      $dir = Split-Path -Parent $fullPath
                      if (-not (Test-Path $dir)) { New-Item -ItemType Directory -Path $dir -Force | Out-Null }
                      Invoke-WebRequest -Uri $file.raw_url -OutFile $fullPath -ErrorAction Stop
                      Write-Host "‚¨áÔ∏è $($file.filename) indirildi"
                  }

                  $page++
              } while ($files.Count -eq 100)
          }

      - name: Download Depot Dumper Tool
        shell: pwsh
        run: |
          $toolDir = "DepotDumper"
          if (-not (Test-Path $toolDir)) { New-Item -ItemType Directory -Path $toolDir -Force | Out-Null }

          $toolUrl = "https://raw.githubusercontent.com/DogancanYr/Steam_Manifest_Depot/main/DepotDumper/Depot.exe"
          $toolPath = Join-Path $toolDir "Depot.exe"
          
          Write-Host "üõ†Ô∏è Depot.exe indiriliyor..."
          Invoke-WebRequest -Uri $toolUrl -OutFile $toolPath -UseBasicParsing -ErrorAction Stop
          Write-Host "‚úÖ Depot.exe indirildi: $toolPath"

      # --- 4) Depot ƒ∞≈ülemi ---
      - name: Run Depot Dumper and Collect Files
        shell: pwsh
        env:
          DEPOT_USER: ${{ secrets.DEPOT_USERNAME }}
          DEPOT_PASS: ${{ secrets.DEPOT_PASSWORD }}
        run: |
          $inputDir = "process_tmp"
          $outputDir = New-Item -ItemType Directory -Path "collected" -Force
          $depotExe = Join-Path $PWD "DepotDumper\Depot.exe"

          if (-not (Test-Path $inputDir)) { exit 0 }

          $pkgFiles = Get-ChildItem -Path $inputDir -Filter '*_pkgs.txt' -Recurse -File
          if ($pkgFiles.Count -eq 0) { exit 0 }

          foreach ($pkg in $pkgFiles) {
              $pkgPath = $pkg.FullName
              $pkgDir = Split-Path -Parent $pkgPath
              $prefix = $pkg.BaseName -replace '_pkgs$', ''
              $keyFile = Join-Path $pkgDir "${prefix}_keys.txt"
              if (-not (Test-Path $keyFile)) { continue }

              $firstLine = (Get-Content -Raw $pkgPath).Trim().Split("`n")[0]
              $parts = $firstLine -split ';'
              if ($parts.Count -lt 2) { continue }

              $appId = $parts[0].Trim()
              $token = $parts[1].Trim()

              Push-Location $outputDir
              try {
                  & $depotExe -username $env:DEPOT_USER -password $env:DEPOT_PASS -app $appId -packagetoken $token -depotkeys $keyFile -Verbose
              } catch {
                  Write-Error "Depot Dumper hatasƒ±: $_"
              } finally { Pop-Location }
          }

      # --- 5) Commit ve Push ---
      - name: Commit and Push via PAT
        shell: pwsh
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO_NAME: ${{ github.repository }}
          BRANCH: main  # Veya istediƒüin branch
        run: |
          git init
          git remote add origin https://x-access-token:$env:PAT_TOKEN@github.com/$env:REPO_NAME.git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add collected/
          if (git diff --cached --quiet) { Write-Host "‚ÑπÔ∏è Yeni deƒüi≈üiklik yok." }
          else {
              git commit -m "Auto-process: Added depot files from PRs"
              git push origin HEAD:$env:BRANCH
          }
