name: PR Depot Process via API

on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  process-pr:
    name: Process PR Depot Files
    runs-on: windows-latest

    steps:
      - name: Fetch PR Files via GitHub API
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          Write-Host "üì• PR #$env:PR_NUMBER dosyalarƒ± indiriliyor..."
          $headers = @{ Authorization = "token $env:GITHUB_TOKEN"; Accept = "application/vnd.github.v3+json" }
          $url = "https://api.github.com/repos/$env:REPO_NAME/pulls/$env:PR_NUMBER/files?per_page=100"
          $files = Invoke-RestMethod -Headers $headers -Uri $url -Method Get
          if (-not $files) { Write-Warning "PR dosyasƒ± yok, i≈ülem atlanƒ±yor."; exit 0 }

          $tempDir = New-Item -ItemType Directory -Path "process_tmp" -Force
          foreach ($file in $files) {
            if ($file.status -eq "removed") { continue }
            $fullPath = Join-Path $tempDir $file.filename
            $dir = Split-Path -Parent $fullPath
            if (-not (Test-Path $dir)) { New-Item -ItemType Directory -Path $dir -Force | Out-Null }
            try {
              Invoke-WebRequest -Uri $file.raw_url -OutFile $fullPath -ErrorAction Stop
              Write-Host "‚¨áÔ∏è ƒ∞ndirildi: $($file.filename)"
            } catch { Write-Error "‚ùå $($file.filename) indirilemedi: $_" }
          }
          Write-Host "‚úÖ PR dosyalarƒ± indirildi."

      - name: Download Depot Dumper Tool
        shell: pwsh
        run: |
          $toolDir = New-Item -ItemType Directory -Path "DepotDumper" -Force
          $toolUrl = "https://raw.githubusercontent.com/DogancanYr/Steam_Manifest_Depot/main/DepotDumper/Depot.exe"
          Invoke-WebRequest -Uri $toolUrl -OutFile (Join-Path $toolDir "Depot.exe") -ErrorAction Stop

      - name: Run Depot Dumper and Collect Files
        shell: pwsh
        env:
          DEPOT_USER: ${{ secrets.DEPOT_USERNAME }}
          DEPOT_PASS: ${{ secrets.DEPOT_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'
          $inputDir = "process_tmp"
          $outputDir = New-Item -ItemType Directory -Path "collected" -Force
          $depotExe = Join-Path $PWD "DepotDumper\Depot.exe"

          if (-not (Test-Path $inputDir)) { Write-Host "ƒ∞≈ülenecek dosya yok, atlanƒ±yor."; exit 0 }

          $pkgFiles = Get-ChildItem -Path $inputDir -Filter '*_pkgs.txt' -Recurse -File
          if ($pkgFiles.Count -eq 0) { Write-Host "ƒ∞≈ülenecek *_pkgs.txt yok."; exit 0 }

          foreach ($pkg in $pkgFiles) {
            $pkgPath = $pkg.FullName
            $pkgDirectory = Split-Path -Parent $pkgPath
            $prefix = $pkg.BaseName -replace '_pkgs$', ''
            $keyFile = Join-Path $pkgDirectory "${prefix}_keys.txt"
            if (-not (Test-Path $keyFile)) { Write-Warning "$($pkg.Name) i√ßin anahtar dosyasƒ± yok"; continue }

            $content = Get-Content -Raw $pkgPath | ForEach-Object { $_ -replace '^\uFEFF', '' }
            $firstLine = $content.Trim().Split("`n")[0]
            $parts = $firstLine -split ';'
            if ($parts.Count -lt 2) { Write-Warning "$($pkg.Name) format hatasƒ±"; continue }

            $appId = $parts[0].Trim()
            $token = $parts[1].Trim()

            Push-Location $outputDir
            try {
              & $depotExe -username $env:DEPOT_USER -password $env:DEPOT_PASS -app $appId -packagetoken $token -depotkeys $keyFile -Verbose
            }
            finally { Pop-Location }
          }

      - name: Commit and Push Results
        shell: bash
        run: |
          git init
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
          git add collected/
          if ! git diff --cached --quiet; then
            git commit -m "Auto-process PR #${{ github.event.pull_request.number }}"
            git push origin HEAD:${{ github.head_ref }}
          fi

      - name: Close Pull Request
        if: success()
        uses: peter-evans/close-pull@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          comment: "‚úÖ ƒ∞≈ülem tamamlandƒ±!"
          delete-branch: true
