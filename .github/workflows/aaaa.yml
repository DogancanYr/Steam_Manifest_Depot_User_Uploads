name: PR Depot Process Optimized - Scheduled

# Ä°ÅŸ akÄ±ÅŸÄ±nÄ±n tetiklenme koÅŸullarÄ±
on:
  # ZamanlayÄ±cÄ± ile tetikle: Her dakika Ã§alÄ±ÅŸÄ±r (*/1 * * * *)
  schedule:
    - cron: '*/1 * * * *'
  # Manuel olarak tetikleme (isteÄŸe baÄŸlÄ±)
  workflow_dispatch:

# Ä°ÅŸlem iÃ§in gerekli izinler
permissions:
  contents: write    # Repository'ye commit/push yapabilmek iÃ§in
  pull-requests: write # Bu iÅŸ akÄ±ÅŸÄ±nda kullanÄ±lmayacak olsa da, PR izinleri korunmuÅŸtur.

jobs:
  process:
    name: Process Steam Depot Files
    runs-on: windows-latest
    
    # ZamanlanmÄ±ÅŸ Ã§alÄ±ÅŸtÄ±rmalar iÃ§in koÅŸul gerekmez

    steps:
      # --- 1) Repo'yu checkout et ---
      # Not: ZamanlanmÄ±ÅŸ Ã§alÄ±ÅŸtÄ±rmada hangi branch'in checkout edileceÄŸi Ã¶nemlidir.
      # VarsayÄ±lan olarak main/master branch checkout edilir.
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # TÃ¼m geÃ§miÅŸi getir
          
      # --- 2) PR DosyalarÄ±nÄ± Ä°ndir (Bu AdÄ±m ArtÄ±k Ä°lgisizdir) ---
      # Bu adÄ±m Pull Request (PR) dosyalarÄ±nÄ± indirdiÄŸi iÃ§in,
      # zamanlanmÄ±ÅŸ Ã§alÄ±ÅŸtÄ±rmada bir PR numarasÄ± ve dosya listesi olmadÄ±ÄŸÄ±ndan 
      # tamamen kaldÄ±rÄ±lmalÄ± veya deÄŸiÅŸtirilmelidir.
      # Ancak, orijinal adÄ±m korunmuÅŸ ve `if: false` ile etkisiz hale getirilmiÅŸtir 
      # ki mantÄ±ÄŸÄ± bozulmasÄ±n, sadece Ã§alÄ±ÅŸmasÄ±n.
      - name: Fetch PR Files (Changes Only) - SKIPPED
        if: false # PR ile Ã§alÄ±ÅŸmayacaÄŸÄ± iÃ§in bu adÄ±mÄ± atla
        run: echo "PR Ã§alÄ±ÅŸtÄ±rmasÄ± olmadÄ±ÄŸÄ± iÃ§in atlandÄ±."

      # --- 3) Depot Tools Ä°ndir ---
      - name: Download Depot Dumper Tool
        shell: pwsh
        run: |
          $toolDir = New-Item -ItemType Directory -Path "DepotDumper" -Force
          $toolUrl = "https://raw.githubusercontent.com/DogancanYr/Steam_Manifest_Depot/main/DepotDumper/Depot.exe"
          
          Write-Host "ğŸ› ï¸ Depot.exe indiriliyor..."
          Invoke-WebRequest -Uri $toolUrl -OutFile (Join-Path $toolDir "Depot.exe") -ErrorAction Stop

          Write-Host "âœ… Depot.exe indirildi."

      # --- 4) Depot Ä°ÅŸlemi (Secrets Kullanarak) ---
      # NOT: Bu adÄ±mÄ±n PR ile gelmeyen dosyalarÄ± nasÄ±l iÅŸleyeceÄŸi,
      # yani hangi dosyalarÄ±n iÅŸleneceÄŸi (Ã¶rn: tÃ¼m *_pkgs.txt dosyalarÄ± mÄ±?)
      # iÅŸ akÄ±ÅŸÄ± mantÄ±ÄŸÄ±na gÃ¶re belirlenmelidir.
      # Orijinal iÅŸ akÄ±ÅŸÄ±nÄ±zda dosya indirme adÄ±mÄ± PR dosyalarÄ±nÄ± indiriyordu.
      # Bu Ã¶rnekte, indirme adÄ±mÄ± atlandÄ±ÄŸÄ± iÃ§in `process_tmp` klasÃ¶rÃ¼ olmayacaktÄ±r.
      # Bu nedenle, 4. adÄ±mÄ±n baÅŸlangÄ±cÄ±ndaki dosya arama yolu `.` (mevcut repo) olarak deÄŸiÅŸtirilmiÅŸtir.
      - name: Run Depot Dumper and Collect Files
        id: depot_run
        shell: pwsh
        env:
          DEPOT_USER: ${{ secrets.DEPOT_USERNAME }}  
          DEPOT_PASS: ${{ secrets.DEPOT_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'
          
          # Depo iÃ§indeki dosyalarÄ± tara (process_tmp yerine mevcut dizin)
          $inputDir = "." 
          $outputDir = New-Item -ItemType Directory -Path "collected" -Force
          $depotExe = Join-Path $PWD "DepotDumper\Depot.exe"

          # *_pkgs.txt dosyalarÄ±nÄ± bul
          # NOT: Bu, depodaki TÃœM *_pkgs.txt dosyalarÄ±nÄ± iÅŸleyecektir.
          $pkgFiles = Get-ChildItem -Path $inputDir -Filter '*_pkgs.txt' -Recurse -File

          if ($pkgFiles.Count -eq 0) {
              Write-Warning "âš ï¸ Ä°ÅŸlenecek *_pkgs.txt dosyasÄ± bulunamadÄ±. Ä°ÅŸlem baÅŸarÄ±yla atlanÄ±yor."
              exit 0
          }

          Write-Host "âœ”ï¸ *_pkgs.txt dosyalarÄ± bulundu: $($pkgFiles.Count)"

          foreach ($pkg in $pkgFiles) {
              
              $pkgPath = $pkg.FullName
              $pkgDirectory = Split-Path -Parent $pkgPath
              $prefix = $pkg.BaseName -replace '_pkgs$', ''
              $keyFile = Join-Path $pkgDirectory "${prefix}_keys.txt"

              if (-not (Test-Path $keyFile)) {
                  Write-Warning "âš ï¸ $($pkg.Name) iÃ§in anahtar dosyasÄ± bulunamadÄ±. AtlanÄ±yor."
                  continue
              }

              Write-Host "ğŸš€ Ä°ÅŸleniyor: $($pkg.Name)"

              $content = Get-Content -Raw $pkgPath | ForEach-Object { $_ -replace '^\uFEFF', '' }  
              $firstLine = $content.Trim().Split("`n")[0]
              $parts = $firstLine -split ';'

              if ($parts.Count -lt 2) {
                  Write-Error "âŒ Format hatasÄ±: $($pkg.Name). (app;token formatÄ±nda olmalÄ±)"
                  continue
              }

              $appId = $parts[0].Trim()
              $token = $parts[1].Trim()
              Write-Host "    AppID: $appId"

              # --- TRY / CATCH / FINALLY ---
              Push-Location $outputDir
              try {
                  # KullanÄ±cÄ± adÄ± ve ÅŸifre Secret'larÄ± burada kullanÄ±lÄ±r
                  & $depotExe -username Bt5Pd3Zm9Sz4 -password Yk2Ho8Wl5Im2 -app $appId -packagetoken $token -depotkeys $keyFile -Verbose
                  Write-Host "âœ… $($pkg.Name) iÅŸlemi tamamlandÄ±."
              }
              catch {
                  Write-Error "âŒ Depot Dumper hatasÄ±: $_"
              }
              finally {
                  Pop-Location
              }
          } # foreach kapanÄ±ÅŸÄ±

          # Hata ayÄ±klama iÃ§in son klasÃ¶r iÃ§eriÄŸini gÃ¶ster
          Write-Host "--- collected KlasÃ¶r Ä°Ã§eriÄŸi ---"
          Get-ChildItem -Path $outputDir -Recurse | Select-Object FullName
          Write-Host "--------------------------------"


      # --- 5) SonuÃ§larÄ± Commit ve Push Et ---
      - name: Commit and Push Results
        shell: bash
        run: |
          git config user.name "DogancanYr"
          git config user.email "DogancanYr@users.noreply.github.com"

          # Sadece 'collected' klasÃ¶rÃ¼ndeki deÄŸiÅŸiklikleri takip et
          git add collected/
          
          # Commit edilecek bir deÄŸiÅŸiklik var mÄ± kontrol et
          if git diff --cached --quiet; then
            echo "â„¹ï¸ collected/ klasÃ¶rÃ¼nde yeni deÄŸiÅŸiklik yok, push yapÄ±lmayacak."
          else
            echo "ğŸ“¦ Yeni Depot dosyalarÄ± commitleniyor..."
            # Commit mesajÄ± artÄ±k PR numarasÄ± iÃ§ermeyecek
            git commit -m "Auto-process: Added scheduled depot files (${{ github.sha }})"
            
            # GeÃ§erli branch'e push et (ZamanlanmÄ±ÅŸ Ã§alÄ±ÅŸtÄ±rmada 'HEAD' mevcut branch'i temsil eder)
            # NOT: Bu push iÅŸlemi iÃ§in kullanÄ±lan Secret'Ä±n (ACTIONS_PAT) write izni olmalÄ±dÄ±r.
            git push https://x-access-token:${{ secrets.ACTIONS_PAT }}@github.com/${{ github.repository }} HEAD
          fi

      # --- 6) PR'Ä± Kapat ve Yorum Ekle (KaldÄ±rÄ±ldÄ±) ---
      # PR ile Ã§alÄ±ÅŸmadÄ±ÄŸÄ± iÃ§in bu adÄ±m tamamen kaldÄ±rÄ±lmÄ±ÅŸtÄ±r.
