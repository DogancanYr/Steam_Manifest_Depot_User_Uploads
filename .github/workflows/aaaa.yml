name: PR Depot Process Optimized (No Checkout)

# Ä°ÅŸ akÄ±ÅŸÄ±nÄ± her 5 dakikada bir Ã§alÄ±ÅŸtÄ±rÄ±r.
on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

# Ä°ÅŸlem iÃ§in gerekli izinler
permissions:
  contents: write    # Repository'ye commit/push yapabilmek iÃ§in

jobs:
  process:
    name: Process Steam Depot Files
    runs-on: windows-latest # Depot.exe Ã§alÄ±ÅŸtÄ±ÄŸÄ± iÃ§in Windows kullanÄ±lÄ±yor

    steps:
      # --- 1) Repo'yu Klonla ve Branch'i Ayarla (actions/checkout yerine) ---
      - name: Git Clone and Setup
        shell: bash
        env:
          # Push ve fetch iÅŸlemleri iÃ§in token
          TOKEN: ${{ secrets.ACTIONS_PAT || secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.ref_name || 'main' }} # VarsayÄ±lan branch'i tahmin et
        run: |
          echo "BaÅŸlangÄ±Ã§ branch'i: $BRANCH"
          
          # Git ayarlarÄ±nÄ± yap
          git config --global user.name "DogancanYr"
          git config --global user.email "DogancanYr@users.noreply.github.com"

          # Repo'yu klonla (derinliÄŸi sÄ±nÄ±rlÄ±)
          git clone --depth 1 "https://x-access-token:$TOKEN@github.com/${{ github.repository }}" .

          # DoÄŸru branch'i kontrol et ve en son deÄŸiÅŸiklikleri Ã§ek
          git fetch origin
          git checkout $BRANCH
          git pull origin $BRANCH

      # --- 2) Gerekli DosyalarÄ± Topla ---
      # Repo klonlandÄ±ÄŸÄ± iÃ§in dosyalar zaten yerel dizinde.
      # Ä°ÅŸlemlerin bir ara dizinde yapÄ±labilmesi iÃ§in *_pkgs.txt dosyalarÄ±nÄ±n bulunduÄŸu 
      # tÃ¼m dosyalarÄ± bir 'process_tmp' dizinine kopyalamak.
      - name: Copy Depot Files to Processing Directory
        shell: pwsh
        run: |
          Write-Host "ğŸ“‚ Ä°ÅŸlenecek dosyalar process_tmp klasÃ¶rÃ¼ne kopyalanÄ±yor..."
          $inputDir = "." # Klonlanan repo dizini
          $tempDir = New-Item -ItemType Directory -Path "process_tmp" -Force
          
          # Depo dosyalarÄ±nÄ±zÄ± (Ã¶rneÄŸin *_pkgs.txt ve *_keys.txt) iÃ§eren tÃ¼m dosyalarÄ± kopyala
          # NOT: Bu kopyalama, 'collected' ve 'DepotDumper' gibi Ã§Ä±ktÄ±/ara dizinleri hariÃ§ tutmalÄ±dÄ±r.
          Get-ChildItem -Path $inputDir -Recurse | Where-Object { 
              $_.PSIsContainer -or $_.Name -like "*_pkgs.txt" -or $_.Name -like "*_keys.txt" 
          } | Copy-Item -Destination { Join-Path $tempDir $_.FullName.Substring($inputDir.Length) } -Force

          # Ä°stenmeyen klasÃ¶rleri hariÃ§ tut (Bu adÄ±m, hatalÄ± kopyalamayÄ± Ã¶nler)
          Remove-Item -Path "process_tmp\collected" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "process_tmp\DepotDumper" -Recurse -Force -ErrorAction SilentlyContinue

          Write-Host "âœ… Dosyalar kopyalandÄ±. process_tmp iÃ§eriÄŸi (bazÄ± dosyalar/klasÃ¶rler atlanabilir):"
          Get-ChildItem -Path $tempDir -Recurse | Select-Object FullName
          Write-Host "----------------------------------"

      # --- 3) Depot Tools Ä°ndir ---
      - name: Download Depot Dumper Tool
        shell: pwsh
        run: |
          $toolDir = New-Item -ItemType Directory -Path "DepotDumper" -Force
          $toolUrl = "https://raw.githubusercontent.com/DogancanYr/Steam_Manifest_Depot/main/DepotDumper/Depot.exe"
          
          Write-Host "ğŸ› ï¸ Depot.exe indiriliyor..."
          Invoke-WebRequest -Uri $toolUrl -OutFile (Join-Path $toolDir "Depot.exe") -ErrorAction Stop

          Write-Host "âœ… Depot.exe indirildi."

      # --- 4) Depot Ä°ÅŸlemi (Secrets Kullanarak) ---
      - name: Run Depot Dumper and Collect Files
        id: depot_run
        shell: pwsh
        env:
          DEPOT_USER: ${{ secrets.DEPOT_USERNAME }}  
          DEPOT_PASS: ${{ secrets.DEPOT_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'
          
          $inputDir = "process_tmp"
          $outputDir = New-Item -ItemType Directory -Path "collected" -Force
          $depotExe = Join-Path $PWD "DepotDumper\Depot.exe"

          if (-not (Test-Path $inputDir)) {
              Write-Host "â„¹ï¸ Ä°ÅŸlenecek dosya klasÃ¶rÃ¼ (process_tmp) yok, iÅŸlem atlanÄ±yor."
              exit 0
          }

          # *_pkgs.txt dosyalarÄ±nÄ± bul
          $pkgFiles = Get-ChildItem -Path $inputDir -Filter '*_pkgs.txt' -Recurse -File

          if ($pkgFiles.Count -eq 0) {
              Write-Warning "âš ï¸ Ä°ÅŸlenecek *_pkgs.txt dosyasÄ± bulunamadÄ±. Ä°ÅŸlem baÅŸarÄ±yla atlanÄ±yor."
              exit 0
          }

          Write-Host "âœ”ï¸ *_pkgs.txt dosyalarÄ± bulundu: $($pkgFiles.Count)"

          foreach ($pkg in $pkgFiles) {
          
              $pkgPath = $pkg.FullName
              $pkgDirectory = Split-Path -Parent $pkgPath
              $prefix = $pkg.BaseName -replace '_pkgs$', ''
              $keyFile = Join-Path $pkgDirectory "${prefix}_keys.txt"

              if (-not (Test-Path $keyFile)) {
                  Write-Warning "âš ï¸ $($pkg.Name) iÃ§in anahtar dosyasÄ± bulunamadÄ±. AtlanÄ±yor."
                  continue
              }

              Write-Host "ğŸš€ Ä°ÅŸleniyor: $($pkg.Name)"

              $content = Get-Content -Raw $pkgPath | ForEach-Object { $_ -replace '^\uFEFF', '' }  
              $firstLine = $content.Trim().Split("`n")[0]
              $parts = $firstLine -split ';'

              if ($parts.Count -lt 2) {
                  Write-Error "âŒ Format hatasÄ±: $($pkg.Name). (app;token formatÄ±nda olmalÄ±)"
                  continue
              }

              $appId = $parts[0].Trim()
              $token = $parts[1].Trim()
              Write-Host "    AppID: $appId"

              # --- TRY / CATCH / FINALLY ---
              Push-Location $outputDir
              try {
                  # Gizli anahtarlar ile Ã§alÄ±ÅŸtÄ±r
                  & $depotExe -username $env:DEPOT_USER -password $env:DEPOT_PASS -app $appId -packagetoken $token -depotkeys $keyFile -Verbose
                  Write-Host "âœ… $($pkg.Name) iÅŸlemi tamamlandÄ±."
              }
              catch {
                  Write-Error "âŒ Depot Dumper hatasÄ±: $_"
              }
              finally {
                  Pop-Location
              }
          } # foreach kapanÄ±ÅŸÄ±

          Write-Host "--- collected KlasÃ¶r Ä°Ã§eriÄŸi ---"
          Get-ChildItem -Path $outputDir -Recurse | Select-Object FullName
          Write-Host "--------------------------------"

      # --- 5) SonuÃ§larÄ± Commit ve Push Et (Klonlanan Repo Ä°Ã§ine) ---
      - name: Commit and Push Results
        shell: bash # Git komutlarÄ± iÃ§in Bash kullanÄ±lÄ±r
        env:
          TOKEN: ${{ secrets.ACTIONS_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # Sadece 'collected' klasÃ¶rÃ¼ndeki deÄŸiÅŸiklikleri takip et
          git add collected/
          
          # Commit edilecek bir deÄŸiÅŸiklik var mÄ± kontrol et
          if git diff --cached --quiet; then
            echo "â„¹ï¸ collected/ klasÃ¶rÃ¼nde yeni deÄŸiÅŸiklik yok, push yapÄ±lmayacak."
          else
            echo "ğŸ“¦ Yeni Depot dosyalarÄ± commitleniyor..."
            
            # Commit mesajÄ±, zamanlanmÄ±ÅŸ Ã§alÄ±ÅŸtÄ±rmayÄ± yansÄ±tÄ±r
            git commit -m "Auto-process: Added depot files from scheduled run ${{ github.sha }}"
            
            # Klonlanan branch'e (HEAD) push et
            # Kimlik doÄŸrulama iÃ§in token kullanÄ±lÄ±r
            git push
            
            echo "âœ… DeÄŸiÅŸiklikler baÅŸarÄ±yla push edildi."
          fi
