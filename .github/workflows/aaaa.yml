name: PR Depot Process Optimized (API Only, No Checkout)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  process:
    name: Process Steam Depot Files
    runs-on: windows-latest

    steps:
      # --- 1) PR Dosyalarƒ±nƒ± ƒ∞ndir (API ile) ---
      - name: Fetch PR Files (Changes Only)
        shell: pwsh
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO_NAME: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        if: github.event_name == 'pull_request'
        run: |
          Write-Host "üì• PR #$env:PR_NUMBER dosyalarƒ± taranƒ±yor ve indiriliyor..."
          
          $headers = @{
            Authorization = "token $env:PAT_TOKEN"
            Accept        = "application/vnd.github.v3+json"
          }

          $page = 1
          $allFiles = @()

          do {
              $url = "https://api.github.com/repos/$env:REPO_NAME/pulls/$env:PR_NUMBER/files?per_page=100&page=$page"
              $files = Invoke-RestMethod -Headers $headers -Uri $url -Method Get
              if ($files.Count -eq 0) { break }
              $allFiles += $files
              $page++
          } while ($files.Count -eq 100)

          if (-not $allFiles) {
            Write-Warning "‚ö†Ô∏è PR i√ßinde dosya bulunamadƒ± veya API yanƒ±t vermedi. ƒ∞≈ülem atlanƒ±yor."
            exit 0
          }

          $tempDir = New-Item -ItemType Directory -Path "process_tmp" -Force
          $downloadCount = 0

          foreach ($file in $allFiles) {
              if ($file.status -eq "removed") { continue }
              $fullPath = Join-Path $tempDir $file.filename
              $dir = Split-Path -Parent $fullPath
              if (-not (Test-Path $dir)) { New-Item -ItemType Directory -Path $dir -Force | Out-Null }

              try {
                  Invoke-WebRequest -Uri $file.raw_url -OutFile $fullPath -ErrorAction Stop
                  Write-Host "‚¨áÔ∏è ƒ∞ndirildi: $($file.filename)"
                  $downloadCount++
              } catch {
                  Write-Error "‚ùå ƒ∞ndirme hatasƒ±: $($file.filename) - $_"
              }
          }

          if ($downloadCount -eq 0) {
            Write-Warning "‚ö†Ô∏è ƒ∞≈ülenecek dosya bulunamadƒ± (removed dƒ±≈üƒ±ndaki dosyalar)."
            exit 0
          }

          Write-Host "‚úÖ Toplam $downloadCount dosya ba≈üarƒ±yla indirildi."
          Write-Host "--- process_tmp Klas√∂r ƒ∞√ßeriƒüi ---"
          Get-ChildItem -Path $tempDir -Recurse | Select-Object FullName
          Write-Host "----------------------------------"

      # --- 2) Depot Tools ƒ∞ndir ---
      - name: Download Depot Dumper Tool
        shell: pwsh
        run: |
          $toolDir = New-Item -ItemType Directory -Path "DepotDumper" -Force
          $toolUrl = "https://raw.githubusercontent.com/DogancanYr/Steam_Manifest_Depot/main/DepotDumper/Depot.exe"
          Write-Host "üõ†Ô∏è Depot.exe indiriliyor..."
          Invoke-WebRequest -Uri $toolUrl -OutFile (Join-Path $toolDir "Depot.exe") -ErrorAction Stop
          Write-Host "‚úÖ Depot.exe indirildi."

      # --- 3) Depot ƒ∞≈ülemi ---
      - name: Run Depot Dumper and Collect Files
        id: depot_run
        shell: pwsh
        env:
          DEPOT_USER: ${{ secrets.DEPOT_USERNAME }} 
          DEPOT_PASS: ${{ secrets.DEPOT_PASSWORD }}
        run: |
          $ErrorActionPreference = 'Stop'
          $inputDir = "process_tmp"
          $outputDir = New-Item -ItemType Directory -Path "collected" -Force
          $depotExe = Join-Path $PWD "DepotDumper\Depot.exe"

          if (-not (Test-Path $inputDir)) {
              Write-Host "‚ÑπÔ∏è ƒ∞≈ülenecek dosya klas√∂r√º yok, i≈ülem atlanƒ±yor."
              exit 0
          }

          $pkgFiles = Get-ChildItem -Path $inputDir -Filter '*_pkgs.txt' -Recurse -File
          if ($pkgFiles.Count -eq 0) {
              Write-Warning "‚ö†Ô∏è *_pkgs.txt dosyasƒ± bulunamadƒ±. ƒ∞≈ülem atlanƒ±yor."
              exit 0
          }

          Write-Host "‚úîÔ∏è *_pkgs.txt dosyalarƒ± bulundu: $($pkgFiles.Count)"

          foreach ($pkg in $pkgFiles) {
              $pkgPath = $pkg.FullName
              $pkgDirectory = Split-Path -Parent $pkgPath
              $prefix = $pkg.BaseName -replace '_pkgs$', ''
              $keyFile = Join-Path $pkgDirectory "${prefix}_keys.txt"

              if (-not (Test-Path $keyFile)) {
                  Write-Warning "‚ö†Ô∏è $($pkg.Name) i√ßin anahtar dosyasƒ± bulunamadƒ±. Atlanƒ±yor."
                  continue
              }

              Write-Host "üöÄ ƒ∞≈üleniyor: $($pkg.Name)"
              $content = Get-Content -Raw $pkgPath | ForEach-Object { $_ -replace '^\uFEFF', '' } 
              $firstLine = $content.Trim().Split("`n")[0]
              $parts = $firstLine -split ';'
              if ($parts.Count -lt 2) {
                  Write-Error "‚ùå Format hatasƒ±: $($pkg.Name). (app;token formatƒ±nda olmalƒ±)"
                  continue
              }

              $appId = $parts[0].Trim()
              $token = $parts[1].Trim()
              Write-Host "    AppID: $appId"

              Push-Location $outputDir
              try {
                  & $depotExe -username $env:DEPOT_USER -password $env:DEPOT_PASS -app $appId -packagetoken $token -depotkeys $keyFile -Verbose
                  Write-Host "‚úÖ $($pkg.Name) i≈ülemi tamamlandƒ±."
              } catch {
                  Write-Error "‚ùå Depot Dumper hatasƒ±: $_"
              } finally {
                  Pop-Location
              }
          }

          Write-Host "--- collected Klas√∂r ƒ∞√ßeriƒüi ---"
          Get-ChildItem -Path $outputDir -Recurse | Select-Object FullName
          Write-Host "--------------------------------"

      # --- 4) Commit ve Push (PAT_TOKEN Kullanarak) ---
      - name: Commit and Push Results via PAT
        shell: pwsh
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO_NAME: ${{ github.repository }}
          BRANCH: ${{ github.head_ref || github.ref_name }}
        run: |
          git init
          git remote add origin https://x-access-token:$env:PAT_TOKEN@github.com/$env:REPO_NAME.git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add collected/

          $diff = git diff --cached --name-only
          if (-not $diff) {
              Write-Host "‚ÑπÔ∏è collected/ klas√∂r√ºnde yeni deƒüi≈üiklik yok, push yapƒ±lmayacak."
          } else {
              git commit -m "Auto-process: Added depot files from PR #${{ github.event.pull_request.number || github.sha }}"
              git push origin HEAD:$env:BRANCH
          }

      # --- 5) PR'ƒ± Kapat ve Yorum Ekle ---
      - name: Close Pull Request
        if: success() && github.event_name == 'pull_request'
        uses: peter-evans/close-pull@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          comment: |
            ‚úÖ **ƒ∞≈ülem Tamamlandƒ±!**
          delete-branch: true
