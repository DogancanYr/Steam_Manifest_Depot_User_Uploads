name: PR Depot Process Optimized API-Only

on:
  schedule:
    - cron: '*/5 * * * *'  # Her 5 dakikada bir Ã§alÄ±ÅŸacak
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  process:
    name: Process Steam Depot Files
    runs-on: windows-latest

    steps:
      # Projeyi ve git geÃ§miÅŸini Ã§ek (Commit adÄ±mÄ± iÃ§in gerekli)
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }} # PAT token'Ä± kullanÄ±yoruz
          fetch-depth: 0 # TÃ¼m geÃ§miÅŸi Ã§ek (isteÄŸe baÄŸlÄ± ama Ã¶nerilir)

      # --- 1) PR Listesini API ile Al (En KÃ¼Ã§Ã¼k PR) ---
      - name: Fetch Smallest Open PR via API
        id: fetch_pr
        shell: pwsh
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO_NAME: ${{ github.repository }}
        run: |
          Write-Host "ğŸ“‹ TÃ¼m aÃ§Ä±k PR'ler Ã§ekiliyor..."

          $headers = @{
              Authorization = "token $env:PAT_TOKEN"
              Accept        = "application/vnd.github.v3+json"
          }

          # Ä°lk 100 aÃ§Ä±k PR'i Ã§ek
          $url = "https://api.github.com/repos/$env:REPO_NAME/pulls?state=open&per_page=100"
          $prs = Invoke-RestMethod -Headers $headers -Uri $url -Method Get

          if (-not $prs) {
              Write-Host "âš ï¸ AÃ§Ä±k PR bulunamadÄ±. Ä°ÅŸlem atlanÄ±yor."
              echo "PR_NUMBER=0" >> $env:GITHUB_OUTPUT
              exit 0
          }

          # PR numaralarÄ±nÄ± al ve en kÃ¼Ã§Ã¼k olanÄ± bul
          $minPRNumber = ($prs | Select-Object -ExpandProperty number | Measure-Object -Minimum).Minimum

          # En kÃ¼Ã§Ã¼k PR'yi bul
          $minPR = $prs | Where-Object { $_.number -eq $minPRNumber }

          # Sonraki adÄ±mlar iÃ§in gerekli bilgiyi dosyaya kaydet
          "$($minPR.number) $($minPR.head.repo.full_name)" | Set-Content -Path "pr_info.txt"
          
          Write-Host "âœ… En kÃ¼Ã§Ã¼k PR numarasÄ± kaydedildi: $($minPR.number)"
          echo "PR_NUMBER=$minPRNumber" >> $env:GITHUB_OUTPUT

      # PR bulunamazsa sonraki adÄ±mlarÄ± atla
      - name: Skip if No PR Found
        if: steps.fetch_pr.outputs.PR_NUMBER == '0'
        run: |
          Write-Host "AÃ§Ä±k PR bulunmadÄ±ÄŸÄ± iÃ§in sonraki adÄ±mlar atlanÄ±yor."
          exit 0
          
      # --- 2) PR DosyalarÄ±nÄ± API ile Ä°ndir ---
      - name: Fetch PR Files
        shell: pwsh
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO_NAME: ${{ github.repository }}
        run: |
          $tempDir = "process_tmp"
          New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

          foreach ($line in Get-Content "pr_info.txt") {
              $parts = $line.Split(' ')
              $prNumber = $parts[0]
              # $headRepo = $parts[1] # Bu bilgiyi bu adÄ±mda kullanmÄ±yoruz

              Write-Host "ğŸ“¥ PR #$prNumber dosyalarÄ± Ã§ekiliyor..."

              $page = 1
              do {
                  $url = "https://api.github.com/repos/$env:REPO_NAME/pulls/$prNumber/files?per_page=100&page=$page"
                  $files = Invoke-RestMethod -Headers @{Authorization="token $env:PAT_TOKEN"; Accept="application/vnd.github.v3+json"} -Uri $url -Method Get
                  if ($files.Count -eq 0) { break }

                  foreach ($file in $files) {
                      if ($file.status -eq "removed") { continue }
                      $fullPath = Join-Path $tempDir $file.filename
                      $dir = Split-Path -Parent $fullPath
                      if (-not (Test-Path $dir)) { New-Item -ItemType Directory -Path $dir -Force | Out-Null }
                      
                      # RAW URL'den dosya iÃ§eriÄŸini indir
                      Invoke-WebRequest -Uri $file.raw_url -OutFile $fullPath -ErrorAction Stop
                      Write-Host "â¬‡ï¸ $($file.filename) indirildi"
                  }

                  $page++
              } while ($files.Count -eq 100)
          }
          
      # --- 3) Depot Dumper Tool Kaynak Kodunu Ä°ndir ---


      # --- 3.5) Depot Dumper Tool'u Derle (Eksik Olan AdÄ±m) ---
      - name: Build Depot Dumper Tool
        shell: pwsh
        run: |
          # .NET Core SDK'nÄ±n yÃ¼klÃ¼ olduÄŸu varsayÄ±lÄ±r (windows-latest Ã¼zerinde varsayÄ±lan).
          $projectPath = Join-Path $PWD "DepotDumper\DepotDownloader"
          
          Write-Host "âš™ï¸ DepotDownloader projesi derleniyor..."
          Push-Location $projectPath
          
          # Release konfigÃ¼rasyonunda derle
          dotnet build -c Release
          Pop-Location
          
      # --- 4) Depot Ä°ÅŸlemi ---
      - name: Run Depot Dumper and Collect Files
        shell: pwsh
        env:
          DEPOT_USER: ${{ secrets.DEPOT_USERNAME }}
          DEPOT_PASS: ${{ secrets.DEPOT_PASSWORD }}
        run: |
          $inputDir = "process_tmp"
          $outputDir = New-Item -ItemType Directory -Path "collected" -Force
          
          # DerlenmiÅŸ DLL yolunu belirle (genellikle net6.0 veya benzeri bir framework klasÃ¶rÃ¼ndedir)
          # Proje adÄ± 'DepotDownloader' olduÄŸu iÃ§in DLL adÄ± da bu ÅŸekilde olmalÄ±dÄ±r.
          # Net framework versiyonunu bulmak iÃ§in alt klasÃ¶rleri ara:
          $buildDir = Get-ChildItem -Path (Join-Path $PWD "DepotDumper\DepotDownloader\bin\Release") -Directory | Select-Object -First 1
          if (-not $buildDir) {
              Write-Error "DerlenmiÅŸ DLL klasÃ¶rÃ¼ bulunamadÄ±. LÃ¼tfen hedef framework'Ã¼ kontrol edin."
              exit 1
          }
          $depotDllPath = Join-Path $buildDir.FullName "DepotDownloader.dll"

          if (-not (Test-Path $inputDir)) { exit 0 }

          $pkgFiles = Get-ChildItem -Path $inputDir -Filter '*_pkgs.txt' -Recurse -File
          if ($pkgFiles.Count -eq 0) { exit 0 }

          foreach ($pkg in $pkgFiles) {
              $pkgPath = $pkg.FullName
              $pkgDir = Split-Path -Parent $pkgPath
              $prefix = $pkg.BaseName -replace '_pkgs$', ''
              $keyFile = Join-Path $pkgDir "${prefix}_keys.txt"
              if (-not (Test-Path $keyFile)) { continue }

              $firstLine = (Get-Content -Raw $pkgPath).Trim().Split("`n")[0]
              $parts = $firstLine -split ';'
              if ($parts.Count -lt 2) { continue }

              $appId = $parts[0].Trim()
              $token = $parts[1].Trim()

              Write-Host "âš™ï¸ $appId iÃ§in Depot Dumper Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
              Push-Location $outputDir
              try {
                  # DLL'i dotnet ile Ã§alÄ±ÅŸtÄ±rÄ±yoruz
                  & dotnet "$depotDllPath" -username $env:DEPOT_USER -password $env:DEPOT_PASS -app $appId -packagetoken $token -depotkeys $keyFile -Verbose
              } catch {
                  Write-Error "Depot Dumper hatasÄ±: $_"
                  # Hata oluÅŸsa bile diÄŸer PR'lara geÃ§mek iÃ§in devam ediyoruz.
              } finally { Pop-Location }
          }

      # --- 5) Commit ve Push ---
      - name: Commit and Push via PAT
        shell: pwsh
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          BRANCH: main  # Veya istediÄŸin branch
        run: |
          # Checkout yapÄ±ldÄ±ÄŸÄ± iÃ§in yeniden init/remote eklemeye gerek yok
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # YalnÄ±zca 'collected' iÃ§indeki deÄŸiÅŸiklikleri ekle
          git add collected/
          
          # DeÄŸiÅŸiklik var mÄ± kontrol et
          if (git diff --cached --quiet) { 
              Write-Host "â„¹ï¸ Yeni deÄŸiÅŸiklik yok. Commit atlanÄ±yor." 
          }
          else {
              $prNumber = (Get-Content "pr_info.txt").Split(' ')[0]
              git commit -m "Auto-process: Added depot files from PR #${prNumber}"
              Write-Host "ğŸš€ DeÄŸiÅŸiklikler $env:BRANCH branch'ine push ediliyor..."
              git push 
          }
